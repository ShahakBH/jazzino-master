# This file has been generated by chef
# Any manual changes will be overwritten.
#
#---------------------------------------------------------------------
# Global settings
#---------------------------------------------------------------------
global
        log 127.0.0.1   local0
        log 127.0.0.1   local1 notice
        #log loghost    local0 info
        maxconn 200000
        #debug
        #quiet
        user haproxy
        group haproxy
        stats socket /var/run/haproxy.sock mode 0600 level admin
        # note: multi-core operation will disable some features, and will cause high softirq waits
        #       don't uncomment unless you're seeing constant 100% core usage by haproxy
        # nbproc 8

defaults
        log         global
        mode        http
        #option forwardfor header X-Client
        #option      httplog
        option      dontlognull
        retries     3
        option      redispatch
        maxconn     150000
#        contimeout  5000
#        clitimeout  50000
#        srvtimeout  50000
        timeout check 5s
        timeout connect 10s
        timeout client 30s
        timeout server 30s
        timeout http-keep-alive 60s
        timeout http-request 20s  # slowloris protection
        default-server inter 3s fall 2 rise 2 slowstart 60s

### lobbies on <%= @lobby_listen_ipv4 %>, <%= @lobby_listen_ipv6 %>

frontend lobbies-port-80-frontend
       bind <%= @lobby_listen_ipv4 %>:80
       bind <%= @lobby_listen_ipv6 %>:80
       mode http
       # close http connection right after serving first "page", since we will redirect to 443 anyway
       option httpclose
       acl maintenance_whitelist src <%= @whitelist.join(' ') %>
       #use_backend lobbies-port-80-backend-maintenance unless maintenance_whitelist
       default_backend lobbies-port-80-backend

backend lobbies-port-80-backend
       balance source
       cookie SERVER_ID insert indirect nocache
       option forwardfor
       option httpchk GET /command/loadBalancerStatus
       http-check expect rstring okay
       stats enable
       stats uri /haproxy?stats
       stats realm Haproxy\ Statistics
       stats auth haproxy:stats
       <%
          cookie_names = ('A'..'Z').to_a
          @lobby_servers.each_pair do |server_name, server_hostname|
            throw "Cookie names exhausted" if cookie_names.empty?
       %>
       server <%= server_name %> <%= server_hostname %>:7900 cookie <%= cookie_names.shift %> check
       <% end %>

backend lobbies-port-80-backend-maintenance
       balance source
       option forwardfor
       option httpchk GET /command/loadBalancerStatus
       http-check expect rstring okay
       stats enable
       stats uri /haproxy?stats
       stats realm Haproxy\ Statistics
       stats auth haproxy:stats
       <% @lobby_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8180 check port 8180
       <% end %>

frontend lobbies-port-10443-frontend
       bind 127.0.0.1:10443
       bind ::1:10443
       mode http
       reqadd X-Forwarded-Proto:\ https
       option httpclose
       acl maintenance_whitelist hdr_ip(X-Forwarded-For) <%= @whitelist.join(' ') %>
       #use_backend lobbies-port-10443-backend-maintenance unless maintenance_whitelist
       default_backend lobbies-port-10443-backend

backend lobbies-port-10443-backend
       balance roundrobin
       cookie SERVER_ID insert indirect nocache
       http-check expect rstring okay
       option httpchk GET /command/loadBalancerStatus
       stats enable
       <%
          cookie_names = ('A'..'Z').to_a
          @lobby_servers.each_pair do |server_name, server_hostname|
            throw "Cookie names exhausted" if cookie_names.empty?
       %>
       server <%= server_name %> <%= server_hostname %>:7900 cookie <%= cookie_names.shift %> check
       <% end %>

backend lobbies-port-10443-backend-maintenance
       balance source
       http-check expect rstring okay
       option httpchk GET /command/loadBalancerStatus
       stats enable
       <% @lobby_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8180 check port 8180
       <% end %>

listen lobbies-port-843
       bind <%= @lobby_listen_ipv4 %>:843
       bind <%= @lobby_listen_ipv6 %>:843
       mode tcp
       balance source
       <% @lobby_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8843 check
       <% end %>

listen lobbies-port-8143
       bind <%= @lobby_listen_ipv4 %>:8143
       bind <%= @lobby_listen_ipv6 %>:8143
       mode tcp
       balance source
       option ssl-hello-chk
       option httpchk GET /available
       http-check expect rstring available
       <% @lobby_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8143 check port 8188
       <% end %>

listen lobbies-port-8188
       bind <%= @lobby_listen_ipv4 %>:8188
       bind <%= @lobby_listen_ipv6 %>:8188
       mode http
       stats enable
       stats uri /haproxy?stats
       stats realm Haproxy\ Statistics
       stats auth haproxy:stats
       balance source
       cookie SERVER_ID insert indirect nocache
       option httpclose
       option forwardfor
       option httpchk GET /available
       http-check expect rstring available
       <%
          cookie_names = ('A'..'Z').to_a
          @lobby_servers.each_pair do |server_name, server_hostname|
            throw "Cookie names exhausted" if cookie_names.empty?
       %>
       server <%= server_name %> <%= server_hostname %>:8188 cookie <%= cookie_names.shift %> check
       <% end %>


### mobile on <%= @mobile_listen_ipv4 %>, <%= @mobile_listen_ipv6 %>
listen mobiles-port-80
       bind <%= @mobile_listen_ipv4 %>:80
       bind <%= @mobile_listen_ipv6 %>:80
       mode http
       option forwardfor
       http-check expect rstring okay
       option httpchk GET /jetty-monitor/load-balancer
       balance source
       <% @mobile_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:7900 check
       <% end %>

listen mobiles-port-443
       bind <%= @mobile_listen_ipv4 %>:443
       bind <%= @mobile_listen_ipv6 %>:443
       mode tcp
       balance source
       http-check expect rstring okay
       option httpchk GET /jetty-monitor/load-balancer
       <% @mobile_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:7943 check port 7900
       <% end %>

listen mobiles-port-8090
       bind <%= @mobile_listen_ipv4 %>:8090
       bind <%= @mobile_listen_ipv6 %>:8090
       mode tcp
       balance source
       <% @mobile_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8090 check
       <% end %>

listen mobiles-port-8091
       bind <%= @mobile_listen_ipv4 %>:8091
       bind <%= @mobile_listen_ipv6 %>:8091
       mode tcp
       balance source
       <% @mobile_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:8091 check
       <% end %>


### workers on <%= @worker_listen_ipv4 %>, <%= @worker_listen_ipv6 %>

listen workers-local-port-7900
       bind <%= @worker_listen_ipv4 %>:7900
       bind <%= @worker_listen_ipv6 %>:7900
       mode http
       balance leastconn
       option httpclose
       option forwardfor
       option httpchk GET /jetty-monitor/load-balancer
       http-check expect rstring okay
       cookie SERVER_ID insert indirect nocache
       <%
          cookie_names = ('A'..'Z').to_a
          @worker_servers.each_pair do |server_name, server_hostname|
            throw "Cookie names exhausted" if cookie_names.empty?
       %>
       server <%= server_name %> <%= server_hostname %>:7900 cookie <%= cookie_names.shift %> check
       <% end %>

listen workers-local-port-7943
       bind <%= @worker_listen_ipv4 %>:7943
       bind <%= @worker_listen_ipv6 %>:7943
       mode tcp
       balance leastconn
       option ssl-hello-chk
       <% @worker_servers.each_pair do |server_name, server_hostname| %>
       server <%= server_name %> <%= server_hostname %>:7943 check
       <% end %>
