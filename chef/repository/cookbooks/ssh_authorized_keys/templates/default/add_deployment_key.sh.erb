#!/bin/bash

###
# Generated by Chef for <%= @node[:fqdn] %>
###

if [ ! -d ~/.ssh ]; then
  mkdir ~/.ssh
  chmod 700 ~/.ssh
fi

# Remove old keys
sed -i'' -e '/goyqo@flux/d' ~/.ssh/authorized_keys

# Ensure current keys exist
for KEY in "$(ls /tmp/keys/*.pub)"; do
    KEY_EXISTS="$(grep -f $KEY ~/.ssh/authorized_keys)"

    if [ -z "$KEY_EXISTS" ]; then
        cat $KEY >> ~/.ssh/authorized_keys
    fi
done

chmod 600 ~/.ssh/authorized_keys
